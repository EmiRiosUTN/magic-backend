// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String            @id @default(uuid())
  email                String            @unique
  passwordHash         String            @map("password_hash")
  fullName             String            @map("full_name")
  role                 UserRole          @default(USER)
  subscriptionTypeId   String?           @map("subscription_type_id")
  isActive             Boolean           @default(true) @map("is_active")
  onboardingCompleted  Boolean           @default(false) @map("onboarding_completed")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  subscriptionType     SubscriptionType? @relation(fields: [subscriptionTypeId], references: [id])
  settings             UserSettings?
  conversations        Conversation[]
  createdAgents        Agent[]           @relation("CreatedAgents")

  @@map("users")
}

model SubscriptionType {
  id                          String   @id @default(uuid())
  name                        String
  maxConversationsPerAgent    Int      @default(5) @map("max_conversations_per_agent")
  maxMessagesPerConversation  Int      @default(100) @map("max_messages_per_conversation")
  maxAgentsAccess             Int?     @map("max_agents_access") // NULL = unlimited
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  users                       User[]

  @@map("subscription_types")
}

model UserSettings {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  language  Language @default(ES)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Category {
  id             String   @id @default(uuid())
  nameEs         String   @map("name_es")
  nameEn         String   @map("name_en")
  descriptionEs  String?  @map("description_es")
  descriptionEn  String?  @map("description_en")
  icon           String?
  displayOrder   Int      @default(0) @map("display_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  agents         Agent[]

  @@map("categories")
}

model Agent {
  id             String      @id @default(uuid())
  categoryId     String      @map("category_id")
  nameEs         String      @map("name_es")
  nameEn         String      @map("name_en")
  descriptionEs  String?     @map("description_es")
  descriptionEn  String?     @map("description_en")
  systemPrompt   String      @map("system_prompt") @db.Text
  aiProvider     AIProvider  @map("ai_provider")
  modelName      String      @map("model_name")
  hasTools       Boolean     @default(false) @map("has_tools")
  toolsConfig    Json?       @map("tools_config")
  isActive       Boolean     @default(true) @map("is_active")
  createdById    String?     @map("created_by_id")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  category       Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdBy      User?       @relation("CreatedAgents", fields: [createdById], references: [id])
  conversations  Conversation[]

  @@map("agents")
}

model Conversation {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  agentId        String    @map("agent_id")
  title          String?
  messageCount   Int       @default(0) @map("message_count")
  lastMessageAt  DateTime? @map("last_message_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent          Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  messages       Message[]

  @@index([userId, agentId, createdAt(sort: Desc)])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String       @map("conversation_id")
  role           MessageRole
  content        String       @db.Text
  tokensUsed     Int?         @map("tokens_used")
  createdAt      DateTime     @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Asc)])
  @@map("messages")
}

model EmailConfig {
  id           String   @id @default(uuid())
  smtpHost     String   @map("smtp_host")
  smtpPort     Int      @map("smtp_port")
  smtpUser     String   @map("smtp_user")
  smtpPassword String   @map("smtp_password")
  fromEmail    String   @map("from_email")
  fromName     String   @map("from_name")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("email_config")
}

// Enums
enum UserRole {
  ADMIN
  USER
}

enum Language {
  ES
  EN
}

enum AIProvider {
  OPENAI
  GEMINI
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}
